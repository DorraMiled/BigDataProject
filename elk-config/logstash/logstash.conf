input {
  # Input pour les logs via TCP
  tcp {
    port => 5000
    codec => json
  }

  # Input pour les logs via HTTP (utile pour Node.js)
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Filtres pour les logs de l'application e-commerce
  if [type] == "order" {
    mutate {
      add_field => { "[@metadata][index]" => "ecommerce-orders-%{+YYYY.MM.dd}" }
    }
  } else if [type] == "user" {
    mutate {
      add_field => { "[@metadata][index]" => "ecommerce-users-%{+YYYY.MM.dd}" }
    }
  } else if [type] == "product" {
    mutate {
      add_field => { "[@metadata][index]" => "ecommerce-products-%{+YYYY.MM.dd}" }
    }
  } else if [type] == "application" {
    mutate {
      add_field => { "[@metadata][index]" => "ecommerce-app-logs-%{+YYYY.MM.dd}" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index]" => "ecommerce-general-%{+YYYY.MM.dd}" }
    }
  }

  # Ajouter un timestamp si non présent
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Parser les données géographiques si présentes
  if [ip] {
    geoip {
      source => "ip"
      target => "geoip"
    }
  }

  # Filtrer les champs inutiles
  mutate {
    remove_field => ["headers", "host"]
  }
}

output {
  # Output vers Elasticsearch avec index dynamique
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    document_type => "_doc"
  }

  # Output vers stdout pour debugging (optionnel)
  stdout {
    codec => rubydebug
  }
}
